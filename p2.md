ðŸ“‹ **TODO LIST POUR CLAUDE CODE - Weather_Gully v3.1**

ðŸš¨ **P0 - CRITIQUE (Ã€ FIXER IMMÃ‰DIATEMENT)**

**1. Mean Reversion sizing multiplier NON appliquÃ©**

\```undefined
Fichier: weather/strategy.py
Ligne: ~900-1000 (fonction d'exÃ©cution des trades)

PROBLÃˆME: Le PriceTracker calcule sizing_multiplier mais ne l'applique jamais au sizing final.

CODE ACTUEL (manquant):
  size = compute_position_size(prob, price, balance, max_position, kelly_frac)
  
CODE CORRECT:
  base_size = compute_position_size(prob, price, balance, max_position, kelly_frac)
  if price_tracker and config.mean_reversion:
      multiplier = price_tracker.sizing_multiplier(location, forecast_date, metric, bucket, price)
      size = base_size * multiplier
  else:
      size = base_size

ACTION: IntÃ©grer le sizing_multiplier dans le calcul final de la taille de position.
\```

ðŸ”´ **P1 - HAUTE PRIORITÃ‰**

**2. Augmenter window size Mean Reversion**

\```undefined
Fichier: weather/mean_reversion.py
Ligne: ~25

ACTUEL: _WINDOW_SIZE = 20  # ~1h40 avec cron 5min

PROBLÃˆME: Trop court pour dÃ©tecter de la mean reversion significative.

ACTION: _WINDOW_SIZE = 150  # ~12h d'historique, signaux plus stables
\```
**3. Correlation threshold trop bas**

\```undefined
Fichier: weather/config.py
Ligne: ~115

ACTUEL: correlation_threshold: float = 0.5

PROBLÃˆME: 0.5 est trop bas - permet d'empiler sur villes proches (NYC/Philly ~0.8)

ACTION: correlation_threshold: float = 0.7
\```
**4. Nettoyage fichiers temporaires Mean Reversion**

\```python
Fichier: weather/mean_reversion.py
Ligne: ~180 (fonction save())

PROBLÃˆME: En cas d'erreur, le fichier temporaire n'est pas supprimÃ©.

CODE ACTUEL:
    except Exception as exc:
        logger.warning("Failed to save mean-reversion state: %s", exc)

ACTION: Ajouter os.unlink(tmp) dans le except:
    except Exception as exc:
        logger.warning("Failed to save mean-reversion state: %s", exc)
        try:
            os.unlink(tmp)
        except OSError:
            pass
\```

ðŸŸ¡ **P2 - MOYENNE PRIORITÃ‰**

**5. Fermeture positions si circuit breaker trigger**

\```undefined
Fichier: weather/strategy.py
Ligne: ~120 (fonction check_circuit_breaker())

PROBLÃˆME: Quand circuit breaker trigger, il bloque les nouveaux trades mais ne ferme pas les positions existantes. Drawdown peut continuer.

ACTION: Ajouter une fonction emergency_exit() appelÃ©e quand circuit breaker trigger:
  \- Vendre toutes les positions Ã  market price
  \- Logger "Emergency exit due to circuit breaker"
  \- Mettre Ã  jour le state
\```
**6. Limitation paramÃ¨tre AR(1)**

\```undefined
Fichier: weather/feedback.py
Ligne: ~200+ (fonction get_bias avec AR(1))

PROBLÃˆME: Si phi (autocorrÃ©lation) proche de 1.0, le biais explose.

ACTION: Clamp |phi| < 0.9:
  phi = min(0.9, max(-0.9, calculated_phi))
\```
**7. Gestion bucket "Other" pour positions NO**

\```undefined
Fichier: weather/strategy.py
Ligne: ~240 (calcul no_prob)

PROBLÃˆME: no_prob = 1.0 - prob suppose que le bucket couvre tout l'univers. Or il y a souvent un bucket "Other" non listÃ©.

ACTION: DÃ©tecter si event a un bucket "Other":
  \- Parser tous les outcome_name de l'event
  \- Si "Other" ou "Any other" prÃ©sent â†’ ajuster no_prob *= 0.9 (conservateur)
  \- Sinon â†’ no_prob = 1.0 - prob (actuel)
\```

ðŸŸ¢ **P3 - FAIBLE PRIORITÃ‰ / OPTIMISATION**

**8. Persistance config aprÃ¨s modification**

\```undefined
Fichier: weather/config.py
Ligne: ~180 (fonction save())

PROBLÃˆME: Actuellement on modifie config.py manuellement, pas via l'API save().

ACTION: Appeler config.save() aprÃ¨s chaque modification de config dans paper_trade.py:
  config.update(overrides)
  config.save(config_dir)  # <- Ajouter cette ligne
\```
**9. PrÃ©-warming Kalman filter**

\```undefined
Fichier: weather/kalman.py
Ligne: ~30 (_DEFAULT_PATH)

PROBLÃˆME: Les premiers trades (5-30) n'utilisent pas Kalman car pas assez d'Ã©chantillons.

ACTION: CrÃ©er un fichier kalman_state.json initial avec des valeurs rÃ©alistes:
  {
    "NYC|short": {"x": 2.5, "P": 1.0, "sample_count": 10},
    "NYC|medium": {"x": 3.5, "P": 1.0, "sample_count": 10},
    ...
  }
\```
**10. Validation Ã¢ge calibration**

\```undefined
Fichier: weather/calibrate.py
Ligne: ~50 (_load_calibration)
\```



\```python
PROBLÃˆME: calibration.json peut Ãªtre vieux de plusieurs mois sans warning.

ACTION: Ajouter check de date:
  metadata = calibration.get("metadata", {})
  calibration_date = metadata.get("date", "")
  if calibration_date:
      age_days = (today - datetime.fromisoformat(calibration_date)).days
      if age_days > 30:
          logger.warning("Calibration is %d days old - consider recalibrating", age_days)
\```

ðŸ“Š **P4 - FEATURES ADDITIONNELLES**

**11. Dashboard mÃ©triques temps rÃ©el**

\```undefined
NOUVEAU FICHIER: weather/dashboard.py

ACTION: CrÃ©er un serveur Flask/FastAPI simple exposant:
  \- GET /metrics â†’ Brier score, Sharpe ratio, win rate
  \- GET /positions â†’ Positions ouvertes avec P&L temps rÃ©el
  \- GET /kalman â†’ Ã‰tat du filtre par location/horizon
\```
**12. ParallÃ©lisation des exits**

\```undefined
Fichier: weather/strategy.py
Ligne: ~350 (check_exit_opportunities)

ACTUEL: SÃ©quentiel
ACTION: ThreadPoolExecutor pour vÃ©rifier les exits en parallÃ¨le (comme pour les entrÃ©es)
\```

âœ… **CHECKLIST VALIDATION**

AprÃ¨s chaque modification:

â€¢ [ ] Tests unitaires passent: `python -m pytest weather/tests/`
â€¢ [ ] Paper trading tourne sans erreur: `python -m weather.paper_trade --verbose`
â€¢ [ ] Config agressive rÃ©appliquÃ©e (5% threshold, 15 trades/run)
â€¢ [ ] 10 positions existantes conservÃ©es (state.json)

ðŸŽ¯ **ORDRE DE PRIORITÃ‰ POUR CLAUDE**

\```undefined

1. P0 - Mean reversion sizing (BUG CRITIQUE)
2. P1 - Window size + Correlation threshold
3. P1 - Nettoyage fichiers temporaires
4. P2 - Emergency exit + AR(1) clamp
5. P3 - Bucket "Other" + Config save
6. P4 - Dashboard (nice to have)

\```
Commencer par le **P0** - c'est le seul bug qui empÃªche une feature de fonctionner ! ðŸ”§